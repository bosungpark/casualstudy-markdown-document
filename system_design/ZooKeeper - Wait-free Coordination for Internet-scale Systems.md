# ZooKeeper: Wait-free Coordination for Internet-scale Systems

## 출처
- **논문**: ZooKeeper: Wait-free Coordination for Internet-scale Systems
- **저자**: Patrick Hunt, Mahadev Konar, Flavio P. Junqueira, Benjamin Reed (Yahoo!)
- **게재**: USENIX ATC 2010
- **원문**: https://www.usenix.org/legacy/event/usenix10/tech/full_papers/Hunt.pdf

---

## AI 요약

### ZooKeeper란?
- **분산 시스템의 "공유 메모장"** 역할을 하는 오픈소스 코디네이션 서비스
- 분산 환경에서 **락, 리더 선출, 설정 관리, 그룹 멤버십** 등 "공통된 상태"를 안전하게 관리
- Google Chubby의 오픈소스 대안 (Yahoo! 개발)


### 핵심 개념

#### 1. 데이터 모델: ZNode 트리
- **트리 구조**: ZooKeeper의 데이터는 파일시스템과 유사한 계층적 네임스페이스(트리)로 구성됨. 각 노드를 ZNode라 부름.
    - **왜 트리인가?**
        - 논문(3.1절)에서 강조하듯, 트리 구조는 분산 시스템의 다양한 "그룹"(예: 서비스, 서버, 리더, 락 등)을 직관적으로 계층화·구분할 수 있게 해줌.
        - `/app1/leader`, `/app1/members`, `/app2/config`처럼 **논리적 그룹핑**과 **네임스페이스 분리**가 쉬움.
        - 부모-자식 관계를 활용해 **Watch, ACL, 구성 관리**를 유연하게 적용 가능(예: 특정 하위 트리 전체에 Watch/권한 부여).
        - 파일시스템과 유사해 개발자에게 익숙하고, API 설계가 단순해짐.
        - 논문에서도 "복잡한 분산 코디네이션 패턴을 단순한 트리 조작으로 구현 가능"하다고 명시.
    - **왜 일반 그래프(사이클/다중 부모 등)는 안 쓰는가?**
        - 논문과 ZooKeeper 설계 철학에 따르면, 일반 그래프 구조(사이클, 다중 부모 등)는 분산 환경에서 **일관성 보장, API 단순성, 장애 복구**를 어렵게 만듦.
        - 사이클이 있으면 "부모-자식" 관계가 불명확해지고, Watch/ACL/버전 관리 등에서 무한 루프·중복 이벤트·권한 충돌 등 복잡한 문제가 발생함.
        - 다중 부모/사이클이 허용되면, "상태 동기화"와 "트랜잭션 순서 보장"이 어려워져 분산 락, 리더 선출 등 코디네이션 패턴이 안전하게 동작하지 않음.
        - 트리는 "단일 경로, 단일 부모"만 허용해 **일관성, 예측 가능성, 장애 복구의 단순화**를 보장함.
        - 즉, 복잡해서 안 쓰는 게 아니라, **분산 코디네이션의 안전성과 단순함을 위해 의도적으로 트리만 허용**하는 것임.
- **ZNode의 특징**:
    - 각 ZNode는 최대 1MB의 데이터와 메타데이터(버전, 타임스탬프, ACL 등)를 저장
    - **Ephemeral Node**: 세션이 끊기면 자동 삭제되는 임시 노드 (리더 선출, 멤버십 관리에 활용)
    - **Sequential Node**: 생성 시 자동으로 일련번호가 붙는 노드 (분산 락, 순서 보장에 활용)
- **버전 관리**: 각 ZNode는 데이터/자식/ACL 별로 별도 버전 번호를 가짐. setData 등은 버전 기반 CAS(Compare-And-Swap) 지원

#### 2. API (간단함!)
- **기본 연산**: create, delete, exists, getData, setData, getChildren
- **Watch**: 클라이언트가 ZNode에 Watch를 등록하면, 해당 노드에 변화(생성/삭제/수정/자식 변경)가 생길 때 1회성 알림을 받음
    - Watch는 "최소 1회" 보장, 유실 가능성 있으므로 반드시 재확인 필요
- **비동기/동기 지원**: 모든 API는 동기/비동기 버전 제공 (대규모 분산 환경 대응)

#### 3. 일관성 모델: 순차적 일관성 (Sequential Consistency)
- **Total Order**: 모든 쓰기 연산은 전역적으로 순서가 보장됨 (모든 서버가 동일한 순서로 적용)
- **읽기 일관성**: 읽기는 최신값이 아닐 수 있으나, 자신의 직전 쓰기 이후의 값은 반드시 읽을 수 있음 ("linearizable read" 옵션도 제공)
- **세션 일관성**: 같은 클라이언트 세션 내에서는 순서가 보장됨
- **단일 리더**: 모든 쓰기는 리더 서버를 통해서만 처리됨

#### 4. ZAB 프로토콜 (ZooKeeper Atomic Broadcast)
- **합의 프로토콜**: Paxos와 유사하지만, 리더 중심으로 단순화됨
- **쓰기 경로**: 리더가 모든 쓰기 요청을 수신 → ZAB로 팔로워에 브로드캐스트 → 과반수(쿼럼) 응답 시 커밋
- **리더 장애 처리**: 리더 장애 시, 남은 서버 중 쿼럼이 새로운 리더를 선출하고 미완료 트랜잭션을 롤백/재적용
- **트랜잭션 ID (zxid)**: 모든 쓰기 연산에 전역적으로 증가하는 zxid(64비트)가 부여되어 순서가 명확히 보장됨

#### 5. 고가용성 및 확장성
- **쿼럼 기반**: 서버는 반드시 홀수(3, 5, 7...)로 구성, 과반수(>N/2) 동작 시 서비스 지속
- **Failover**: 일부 서버 장애에도 정상 동작, 리더 장애 시 자동 failover
- **읽기 분산**: 클라이언트는 임의의 서버에 연결해 읽기 가능 (쓰기만 리더 경유)
- **지리적 분산**: 여러 데이터센터에 ZooKeeper ensemble을 분산 배치 가능 (네트워크 지연 고려)

### 대표적 사용 사례
- **분산 락**: 여러 서버가 동시에 자원 접근 방지
- **리더 선출**: 여러 노드 중 하나만 "리더"로 동작
- **구성 관리**: 설정 파일을 ZooKeeper에 저장, 실시간 반영
- **그룹 멤버십**: 현재 살아있는 서버 목록 관리

### 실제 코드 예시 (Python)
```python
from kazoo.client import KazooClient
zk = KazooClient(hosts='127.0.0.1:2181')
zk.start()

# 노드 생성
zk.create("/mylock", b"locked")

# 데이터 읽기
value, stat = zk.get("/mylock")
print(value)

# Watch 등록
@zk.DataWatch("/mylock")
def watch_node(data, stat):
    print("노드 변경 감지!", data)

# 노드 삭제
zk.delete("/mylock")
zk.stop()
```

### 한계 및 주의점
- **데이터 저장소 아님**: 대용량 데이터 저장 불가 (1MB 제한)
- **순차적 일관성**: 강한 일관성(X), 최신값 보장(X)
- **Split-brain**: 쿼럼 미만 서버만 남으면 서비스 불가
- **Watch 이벤트 유실 가능**: 반드시 재확인 필요

---

## 내가 얻은 인사이트

**1. "분산 시스템의 공유 메모장"이 중요한 이유**
분산 시스템에서 **공통된 상태**를 안전하게 관리하는 건 생각보다 어려움. ZooKeeper는 이걸 아주 단순한 API와 트리 구조로 해결. "공유 메모장"이 있으면, 각 서버가 서로 복잡하게 통신하지 않아도 됨.

**2. "Watch"와 "순차적 일관성"의 조합**
ZooKeeper는 모든 쓰기를 리더가 순서대로 처리해서 "순차적 일관성"을 보장. 하지만 읽기는 최신값이 아닐 수 있음. 대신, 변화가 생기면 Watch로 알림을 줌. 이 조합이 분산 락, 리더 선출, 설정 관리 등 다양한 패턴을 간단하게 만듬.

**3. "데이터 저장소"가 아니라 "코디네이션 서비스"다**
ZooKeeper에 대용량 데이터를 넣으면 안 됨. 1MB 제한, 순차적 일관성, Watch 유실 가능성 등은 "상태 관리"에만 집중하라는 신호. 실제로 HBase, Kafka, Hadoop 등도 ZooKeeper를 "상태 동기화" 용도로만 씀. "데이터 저장은 DB, 코디네이션은 ZooKeeper"가 정석.
